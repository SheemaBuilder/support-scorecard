<!doctype html>
<html>
  <head>
    <title>Debug API Endpoints</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .result {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        overflow-x: auto;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h1>API Debug Tool</h1>

    <div class="section">
      <h2>Health Check</h2>
      <button onclick="testHealth()">Test Health</button>
      <div id="health-result" class="result"></div>
    </div>

    <div class="section">
      <h2>Users</h2>
      <button onclick="testUsers()">Test Users</button>
      <div id="users-result" class="result"></div>
    </div>

    <div class="section">
      <h2>Tickets</h2>
      <button onclick="testTickets()">Test Tickets</button>
      <div id="tickets-result" class="result"></div>
    </div>

    <div class="section">
      <h2>Satisfaction Ratings</h2>
      <button onclick="testRatings()">Test Satisfaction Ratings</button>
      <div id="ratings-result" class="result"></div>
    </div>

    <div class="section">
      <h2>Complete Engineer Metrics</h2>
      <button onclick="testEngineers()">Test Engineer Calculation</button>
      <div id="engineers-result" class="result"></div>
    </div>

    <script>
      async function testHealth() {
        try {
          const response = await fetch("/api/health");
          const data = await response.json();
          document.getElementById("health-result").innerHTML =
            `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (error) {
          document.getElementById("health-result").innerHTML =
            `<span style="color: red;">Error: ${error.message}</span>`;
        }
      }

      async function testUsers() {
        try {
          const response = await fetch("/api/zendesk/users");
          const data = await response.json();
          document.getElementById("users-result").innerHTML = `
                    <div>Total users: ${data.users.length}</div>
                    <pre>${JSON.stringify(
                      data.users.map((u) => ({
                        id: u.id,
                        name: u.name,
                        email: u.email,
                      })),
                      null,
                      2,
                    )}</pre>
                `;
        } catch (error) {
          document.getElementById("users-result").innerHTML =
            `<span style="color: red;">Error: ${error.message}</span>`;
        }
      }

      async function testTickets() {
        try {
          const response = await fetch("/api/zendesk/tickets");
          const data = await response.json();
          document.getElementById("tickets-result").innerHTML = `
                    <div>Total tickets: ${data.tickets.length}</div>
                    <div>Sample tickets:</div>
                    <pre>${JSON.stringify(
                      data.tickets.slice(0, 3).map((t) => ({
                        id: t.id,
                        status: t.status,
                        assignee_id: t.assignee_id,
                        created_at: t.created_at,
                        solved_at: t.solved_at,
                      })),
                      null,
                      2,
                    )}</pre>
                `;
        } catch (error) {
          document.getElementById("tickets-result").innerHTML =
            `<span style="color: red;">Error: ${error.message}</span>`;
        }
      }

      async function testRatings() {
        try {
          const response = await fetch("/api/zendesk/satisfaction_ratings");
          const data = await response.json();
          document.getElementById("ratings-result").innerHTML = `
                    <div>Total ratings: ${data.satisfaction_ratings.length}</div>
                    <pre>${JSON.stringify(data.satisfaction_ratings.slice(0, 5), null, 2)}</pre>
                `;
        } catch (error) {
          document.getElementById("ratings-result").innerHTML =
            `<span style="color: red;">Error: ${error.message}</span>`;
        }
      }

      async function testEngineers() {
        try {
          // Simulate what the frontend does
          const [usersResponse, ticketsResponse, ratingsResponse] =
            await Promise.all([
              fetch("/api/zendesk/users"),
              fetch("/api/zendesk/tickets"),
              fetch("/api/zendesk/satisfaction_ratings"),
            ]);

          const users = await usersResponse.json();
          const tickets = await ticketsResponse.json();
          const ratings = await ratingsResponse.json();

          // Calculate metrics for each engineer
          const engineerMetrics = users.users.map((user) => {
            const userTickets = tickets.tickets.filter(
              (ticket) => ticket.assignee_id === user.id,
            );
            const userRatings = ratings.satisfaction_ratings.filter(
              (rating) => rating.assignee_id === user.id,
            );

            const closedTickets = userTickets.filter(
              (ticket) =>
                ticket.status === "closed" || ticket.status === "solved",
            );

            const openTickets = userTickets.filter(
              (ticket) =>
                ticket.status === "new" ||
                ticket.status === "open" ||
                ticket.status === "pending",
            );

            return {
              name: user.name,
              totalTickets: userTickets.length,
              closedTickets: closedTickets.length,
              openTickets: openTickets.length,
              ratingsCount: userRatings.length,
            };
          });

          document.getElementById("engineers-result").innerHTML = `
                    <div>Engineer Metrics:</div>
                    <pre>${JSON.stringify(engineerMetrics, null, 2)}</pre>
                `;
        } catch (error) {
          document.getElementById("engineers-result").innerHTML =
            `<span style="color: red;">Error: ${error.message}</span>`;
        }
      }
    </script>
  </body>
</html>
